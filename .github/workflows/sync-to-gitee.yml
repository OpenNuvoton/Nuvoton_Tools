name: Sync to Gitee

on:
  # 新增這段：監聽 Push 事件
  push:
    branches: [ master, main ]  # 當 master 或 main 分支有更新時觸發
  
  # 保留這段：讓你還是可以手動按按鈕 (方便除錯或強制同步)
  workflow_dispatch:
  
permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 需要所有 refs 和 tags

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add Gitee remote (HTTPS token auth)
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          set -e
          # remove existing to avoid duplicate
          git remote remove gitee || true
          # use oauth2 style token auth for Gitee
          git remote add gitee https://oauth2:${GITEE_TOKEN}@gitee.com/OpenNuvoton/Nuvoton_Tools.git
          git remote -v

      - name: Fetch origin refs
        run: git fetch origin --prune

      - name: Push all branches and tags to Gitee
        env:
          GIT_TERMINAL_PROMPT: 0
        run: |
          set -e
          # 強制同步所有分支與 tags（請確認你要 force push）
          git push -f gitee refs/remotes/origin/*:refs/heads/* --tags --prune
